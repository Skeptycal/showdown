stages: [test, dist]

before_script:
    - export MAKEFLAGS="-j$(mk/nproc.sh)"

test:dynamic:
    stage: test
    image: registry.gitlab.com/craigbarnes/dockerfiles/vala-debian
    script:
        - apt-get update && apt-get -y install libmarkdown2-dev
        - make
        - make install
        - meson build/meson/
        - ninja -C build/meson/ install

test:static:
    stage: test
    image: registry.gitlab.com/craigbarnes/dockerfiles/vala-debian
    script:
        - make USE_LOCAL_DISCOUNT=1
        - make install

pages:
    stage: dist
    image: registry.gitlab.com/craigbarnes/dockerfiles/vala-debian
    artifacts: {paths: [public]}
    only: [master]
    script:
        - flatpak -v remote-add gnome https://sdk.gnome.org/gnome.flatpakrepo
        - flatpak -v install gnome org.gnome.Platform 3.24
        - flatpak -v install gnome org.gnome.Sdk 3.24
        - echo "$GPG_PRIVATE_KEY" | gpg --import -
        - make flatpak FLATPAK_EXPORT_FLAGS='--gpg-sign=43705BA1'
        - echo "$GPG_PUBLIC_KEY" | flatpak -v remote-add --gpg-import=- showdown public/flatpak/
        - flatpak -v install showdown org.gnome.Showdown
        - flatpak info org.gnome.Showdown
        - make check-dist
